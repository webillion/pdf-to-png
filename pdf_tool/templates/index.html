<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaSnap Turbo｜1500枚/1分処理モデル</title>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MTB190WE2E"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-MTB190WE2E');
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        .checkerboard {
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%), linear-gradient(-45deg, #eee 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #eee 75%), linear-gradient(-45deg, transparent 75%, #eee 75%);
            background-size: 20px 20px;
        }
        @keyframes pulse-fast { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .processing-active { animation: pulse-fast 1s infinite; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col items-center py-10 px-4 font-sans">

    <header class="text-center mb-8">
        <h1 class="text-4xl font-black italic tracking-tighter mb-2">AlphaSnap <span class="text-blue-600">TURBO</span></h1>
        <div id="status-area" class="bg-white px-4 py-1 rounded-full shadow-sm border border-slate-200 text-sm">
            <span id="usage-text" class="font-bold">Ready</span>
        </div>
    </header>

    <main class="w-full max-w-xl bg-white p-8 rounded-3xl shadow-2xl border border-slate-100">
        <div class="mb-6 flex items-center justify-between p-4 bg-slate-900 text-white rounded-2xl shadow-inner">
            <div class="flex items-center gap-3">
                <i data-lucide="zap" class="text-yellow-400 fill-yellow-400"></i>
                <span class="font-bold">背景透過を有効化</span>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="transparent-toggle" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-slate-700 rounded-full peer peer-checked:bg-blue-500 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
            </label>
        </div>

        <div id="drop-zone" class="border-4 border-dashed border-slate-200 rounded-2xl p-12 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all group relative overflow-hidden">
            <input type="file" id="file-input" class="hidden" accept="application/pdf">
            <div class="relative z-10">
                <i data-lucide="cloud-lightning" class="w-16 h-16 mx-auto mb-4 text-slate-300 group-hover:text-blue-500 group-hover:scale-110 transition-transform"></i>
                <p class="text-xl font-black text-slate-600">PDFをドロップして爆速変換</p>
                <p id="file-name" class="mt-4 text-blue-600 font-bold bg-blue-100 px-3 py-1 rounded-lg inline-block hidden"></p>
            </div>
        </div>

        <button id="convert-btn" class="w-full mt-8 bg-blue-600 text-white font-black py-5 rounded-2xl text-xl shadow-lg hover:bg-blue-700 active:scale-95 transition-all flex items-center justify-center gap-3">
            <i data-lucide="play" class="fill-current"></i> 変換してZIP保存
        </button>

        <div id="progress-container" class="hidden mt-8">
            <div class="flex justify-between text-sm font-black mb-2 text-slate-500">
                <span id="progress-text">SPEED: BOOSTING...</span>
                <span id="percentage-text">0%</span>
            </div>
            <div class="w-full bg-slate-100 rounded-full h-4 overflow-hidden shadow-inner">
                <div id="progress-bar" class="bg-gradient-to-r from-blue-400 to-blue-600 h-full transition-all duration-100" style="width: 0%"></div>
            </div>
        </div>

        <div id="result-area" class="hidden mt-8 grid grid-cols-5 gap-2 max-h-48 overflow-y-auto p-3 border rounded-2xl bg-slate-50 shadow-inner"></div>
    </main>

    <div id="vip-modal" class="fixed inset-0 bg-slate-900/80 hidden items-center justify-center z-50 backdrop-blur-md">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-2xl font-black mb-6">LIMIT REACHED</h3>
            <input type="password" id="vip-password" placeholder="Passcode" class="w-full p-4 bg-slate-100 rounded-xl mb-4 outline-none focus:ring-4 focus:ring-blue-500/20 text-center font-bold">
            <button onclick="unlockVip()" class="w-full py-4 bg-blue-600 text-white font-black rounded-xl shadow-lg">UNLOCK</button>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name');
        const convertBtn = document.getElementById('convert-btn');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const percentageText = document.getElementById('percentage-text');
        const resultArea = document.getElementById('result-area');
        const transparentToggle = document.getElementById('transparent-toggle');

        let currentFile = null;

        // UIイベント
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFileSelect(e.target.files[0]);
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('bg-blue-50', 'border-blue-400'); };
        dropZone.ondragleave = () => dropZone.classList.remove('bg-blue-50', 'border-blue-400');
        dropZone.ondrop = (e) => { e.preventDefault(); handleFileSelect(e.dataTransfer.files[0]); };

        function handleFileSelect(file) {
            if (file?.type === 'application/pdf') {
                currentFile = file;
                fileNameDisplay.textContent = file.name;
                fileNameDisplay.classList.remove('hidden');
            }
        }

        // 高速透明化ロジック (32bit)
        function fastRemoveWhite(ctx, width, height) {
            const imgData = ctx.getImageData(0, 0, width, height);
            const data = new Uint32Array(imgData.data.buffer);
            const threshold = 250;
            for (let i = 0; i < data.length; i++) {
                const val = data[i];
                if ((val & 0xFF) >= threshold && ((val >> 8) & 0xFF) >= threshold && ((val >> 16) & 0xFF) >= threshold) {
                    data[i] = 0;
                }
            }
            ctx.putImageData(imgData, 0, 0);
        }

        convertBtn.onclick = async () => {
            if (!currentFile) return;
            convertBtn.disabled = true;
            
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                if (data.is_vip) await processTurbo(currentFile);
                else {
                    const inc = await fetch('/api/increment', { method: 'POST' });
                    if (inc.ok) await processTurbo(currentFile);
                    else document.getElementById('vip-modal').classList.replace('hidden', 'flex');
                }
            } catch (e) { alert('API Error'); convertBtn.disabled = false; }
        };

        async function processTurbo(file) {
            progressContainer.classList.remove('hidden');
            resultArea.innerHTML = '';
            resultArea.classList.remove('hidden');
            
            const zip = new JSZip();
            const isTransparent = transparentToggle.checked;
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer, verbosity: 0}).promise;
            const total = pdf.numPages;

            // コア数に合わせて並列実行数を調整 (最大8並列)
            const concurrency = Math.min(navigator.hardwareConcurrency || 4, 8);
            let processed = 0;

            const processPage = async (pageNum) => {
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d', { alpha: true });

                await page.render({ canvasContext: ctx, viewport, background: 'transparent' }).promise;
                
                if (isTransparent) fastRemoveWhite(ctx, canvas.width, canvas.height);

                const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
                zip.file(`${pageNum}.png`, blob);

                // プレビュー（最初の30枚のみ）
                if (pageNum <= 30) {
                    const url = URL.createObjectURL(blob);
                    const div = document.createElement('div');
                    div.className = `p-0.5 border rounded ${isTransparent ? 'checkerboard' : 'bg-white'}`;
                    div.innerHTML = `<img src="${url}" class="w-full">`;
                    resultArea.appendChild(div);
                }

                processed++;
                const percent = Math.floor((processed / total) * 100);
                progressBar.style.width = percent + '%';
                percentageText.textContent = percent + '%';
                progressText.textContent = `PROCESSING: ${processed} / ${total}`;
                
                // メモリ解放
                canvas.width = 0; canvas.height = 0;
            };

            // キュー制御による並列実行
            const queue = Array.from({length: total}, (_, i) => i + 1);
            const workers = Array(concurrency).fill(null).map(async () => {
                while (queue.length > 0) {
                    await processPage(queue.shift());
                }
            });

            await Promise.all(workers);

            progressText.textContent = 'FINALIZING ZIP...';
            const content = await zip.generateAsync({ type: "blob", compression: "STORE" });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `AlphaSnap_Turbo_${Date.now()}.zip`;
            link.click();

            progressText.textContent = 'COMPLETE!';
            convertBtn.disabled = false;
        }

        async function checkStatus() {
            const res = await fetch('/api/status');
            const data = await res.json();
            document.getElementById('usage-text').innerHTML = data.is_vip ? '✨ VIP UNLIMITED' : `REMAINING: ${3 - data.count} / 3`;
        }
        checkStatus();
    </script>
</body>
</html>
