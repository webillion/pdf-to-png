<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MTB190WE2E"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MTB190WE2E');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaSnap | PDF to PNG Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #050505; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
        .checkerboard { background-image: linear-gradient(45deg, #222 25%, transparent 25%), linear-gradient(-45deg, #222 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #222 75%), linear-gradient(-45deg, transparent 75%, #222 75%); background-size: 20px 20px; background-color: #111; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .progress-glow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { animation: rotate 1s linear infinite; }
    </style>
</head>
<body class="flex flex-col">

    <header class="h-16 border-b border-white/10 flex items-center px-6 justify-between z-50 bg-black/50">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <i data-lucide="zap" class="text-blue-500 fill-blue-500 w-5 h-5"></i>
                <span class="font-black tracking-tighter text-xl">ALPHASNAP</span>
            </div>
            <div id="usage-tag" class="text-[10px] font-bold text-slate-500 border border-white/10 px-3 py-1 rounded-full cursor-pointer hover:bg-white/5" onclick="showVipModal()">
                LOADING...
            </div>
        </div>

        <div id="nav-actions" class="flex gap-3">
            <button id="convert-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-6 py-2 rounded-lg text-sm transition-all disabled:opacity-50">START CONVERSION(変換開始)</button>
            <button id="download-btn" class="hidden bg-green-600 hover:bg-green-500 text-white font-bold px-6 py-2 rounded-lg text-sm transition-all flex items-center gap-2">
                <i data-lucide="download" class="w-4 h-4"></i> DOWNLOAD ZIP
            </button>
            <button id="cancel-btn" class="hidden text-slate-400 hover:text-white text-xs font-bold px-4">CANCEL(キャンセル)</button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <aside class="w-72 border-r border-white/10 p-6 flex flex-col gap-6 bg-black/20">
            <div>
                <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3 block">Convert PDF to PNG<br>(以下のPDFをPNGに変換する)</label>
                <div id="drop-zone" class="h-32 border-2 border-dashed border-white/10 rounded-2xl flex flex-col items-center justify-center p-4 text-center hover:border-blue-500 transition-all cursor-pointer group">
                    <input type="file" id="file-input" class="hidden" accept="application/pdf">
                    <div id="drop-ui">
                        <i data-lucide="plus" class="w-6 h-6 mb-2 text-slate-500 group-hover:text-blue-500"></i>
                        <span class="text-[10px] font-bold text-slate-500">Click to select a file or drag & drop here<br>ファイルをクリックして選択<br>もしくは<br>ドラック＆ドロップしてください</span>
                    </div>
                    <div id="file-ready-ui" class="hidden w-full">
                        <p id="file-name-display" class="text-blue-400 font-bold text-[10px] truncate"></p>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest block">Options(オプション)</label>
                <div class="flex items-center justify-between p-3 glass rounded-xl">
                    <span class="text-xs font-medium">背景を透明にする</span>
                    <input type="checkbox" id="transparent-toggle" checked class="w-4 h-4 rounded bg-slate-800 border-none">
                </div>
            </div>

            <div id="status-card" class="mt-auto p-4 glass rounded-2xl hidden">
                <div class="flex justify-between items-center mb-2">
                    <span id="process-label" class="text-[10px] font-black text-blue-400 uppercase">Processing</span>
                    <span id="percent-label" class="text-lg font-black italic">0%</span>
                </div>
                <div class="w-full bg-white/5 h-1.5 rounded-full overflow-hidden mb-3">
                    <div id="progress-bar" class="h-full bg-blue-500 w-0 transition-all duration-300 progress-glow"></div>
                </div>
                <div class="flex justify-between text-[10px] font-bold text-slate-500">
                    <span id="page-count">PAGE 0 / 0</span>
                    <span id="time-estimate">--:--</span>
                </div>
            </div>

            <div class="mt-2 text-center">
                <a id="openTerms" class="text-[10px] text-slate-600 hover:text-slate-400 cursor-pointer transition-colors uppercase font-bold tracking-widest">Terms of Service(ご利用にあたって)</a>
            </div>     
        </aside>

        <section class="flex-1 bg-black flex flex-col items-center justify-center p-8 relative">
            <div id="preview-container" class="w-full max-w-lg aspect-[1/1.41] checkerboard rounded-lg shadow-2xl overflow-hidden border border-white/10 relative group scale-95 opacity-50 transition-all duration-700">
                <img id="main-preview" class="w-full h-full object-contain">
                <div class="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-[.processing]:opacity-100 transition-opacity">
                    <i data-lucide="refresh-cw" class="w-12 h-12 text-blue-500 spinner"></i>
                </div>
            </div>
            
            <div id="success-overlay" class="absolute inset-0 bg-black/90 hidden items-center justify-center z-40">
                <div class="text-center">
                    <div class="w-16 h-16 bg-green-500/20 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 border border-green-500/30">
                        <i data-lucide="check" class="w-8 h-8"></i>
                    </div>
                    <h2 class="text-2xl font-black mb-2">CONVERSION COMPLETE</h2>
                    <p class="text-slate-500 text-sm mb-8">Your files are ready for download.</p>
                    <button onclick="location.reload()" class="px-8 py-3 glass rounded-xl text-xs font-bold hover:bg-white/10">CONVERT ANOTHER</button>
                </div>
            </div>
        </section>
    </main>

    <div id="vip-modal" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-[100] p-6">
        <div class="max-w-sm w-full glass p-8 rounded-[32px] text-center border border-white/10">
        <h3 class="text-xl font-black mb-2 italic uppercase">Unlock Access</h3>
        <p id="modal-status-text" class="text-slate-500 text-xs font-bold mb-6 uppercase">
            FREE LIMIT(無料枠): <span id="modal-usage-left" class="text-blue-500">3</span> / 3 LEFT
        </p>
    <input type="password" id="vip-pass" placeholder="ENTER PASSCODE" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl mb-4 text-center font-mono focus:border-blue-500 outline-none">
    <button onclick="unlockVip()" class="w-full py-4 bg-white text-black font-black rounded-xl hover:bg-slate-200 transition-all text-xs uppercase tracking-tighter">Authorize Device</button>
    <button onclick="hideVipModal()" class="mt-4 text-[10px] text-slate-500 font-bold uppercase">Close</button>
</div>
    </div>
    <div id="terms-modal" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-[110] p-6">
        <div class="max-w-xl w-full glass p-8 rounded-[32px] border border-white/10 flex flex-col max-h-[80vh]">
            <h3 class="text-xl font-black mb-4 italic uppercase text-center">TERMS OF SERVICE(ご利用にあたって)</h3>
            
            <div class="overflow-y-auto pr-2 text-left space-y-6 text-slate-400 text-xs leading-relaxed">
                <section>
                    <h4 class="text-white font-bold mb-1 uppercase tracking-tighter">1. VIP ACCESS</h4>
                    <p>VIP PASSCODES ARE FOR PERSONAL USE ONLY. REDISTRIBUTION, RESALE, OR PUBLIC SHARING IS STRICTLY PROHIBITED. VIOLATIONS WILL RESULT IN PERMANENT REVOCATION OF ACCESS WITHOUT PRIOR NOTICE.</p>
                    <p>VIPパスワードは購入者本人のみが利用可能です。第三者への譲渡、公開、転売は固く禁止します。流出が確認された場合、事前の通知なく無効化します。</p>
                </section>

                <section>
                    <h4 class="text-blue-500 font-bold mb-1 uppercase tracking-tighter italic">2. IMPORTANT: PERSISTENCE & SESSION(2. 重要: 注意点)</h4>
                    <p>To ensure maximum privacy and speed, your authentication status is stored in temporary server memory. Please note that the VIP status may be reset due to server reboots or system updates. In such cases, simply re-enter your passcode to restore access.</p>
                    <p>本サービスは動作の軽量化とプライバシー保護のため、認証状態を一時的なメモリに保存しています。<strong>サーバーの再起動等により、VIP状態が解除され再度パスワード入力を求められる場合があります</strong>が、これは仕様です。パスワードを再入力することで復帰可能です。</p>
                </section>

                <section>
                    <h4 class="text-white font-bold mb-1 uppercase tracking-tighter">3. REFUND POLICY(3. ご返金について)</h4>
                    <p>Due to the digital nature of this product, all sales are final. No refunds will be issued once a passcode has been generated, including cases related to the session resets described in Section 2.</p>
                    <p>商品の性質上、パスワード発行後の返金には応じられません。第2条の仕様を理由とした返金も受け付けないものとします。</p>
                </section>
            </div>

            <button id="closeTermsBtn" class="mt-8 w-full py-4 glass text-white font-black rounded-xl hover:bg-white/10 transition-all text-xs uppercase tracking-tighter">Close</button>
        </div>
    </div>
    <script>
        lucide.createIcons();

        // Constants
        const deviceId = (() => {
            let id = localStorage.getItem('alpha_device_id');
            if (!id) {
                id = 'dev_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('alpha_device_id', id);
            }
            return id;
        })();

        let isProcessing = false;
        let currentFile = null;
        let zipResultBlob = null;

        // Elements
        const fileInput = document.getElementById('file-input');
        const convertBtn = document.getElementById('convert-btn');
        const downloadBtn = document.getElementById('download-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const progressBar = document.getElementById('progress-bar');
        const pageCountEl = document.getElementById('page-count');
        const statusCard = document.getElementById('status-card');

        // File Selection
        document.getElementById('drop-zone').onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFile(e.target.files[0]);
        window.ondragover = (e) => e.preventDefault();
        window.ondrop = (e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); };

        function handleFile(file) {
            if (file?.type === 'application/pdf') {
                currentFile = file;
                document.getElementById('file-ready-ui').classList.remove('hidden');
                document.getElementById('drop-ui').classList.add('hidden');
                document.getElementById('file-name-display').textContent = file.name;
                document.getElementById('preview-container').style.opacity = "1";
                document.getElementById('preview-container').style.transform = "scale(1)";
            }
        }

        // Logic
        convertBtn.onclick = async () => {
            if (!currentFile || isProcessing) return;

            const res = await fetch('/api/status', { headers: { 'x-device-id': deviceId } });
            const status = await res.json();
            if (status.count >= 3 && !status.is_vip) return showVipModal();

            await fetch('/api/increment', { method: 'POST', headers: { 'x-device-id': deviceId } });

            startConversion();
        };

        async function startConversion() {
            isProcessing = true;
            convertBtn.disabled = true;
            convertBtn.textContent = "PROCESSING...";
            cancelBtn.classList.remove('hidden');
            statusCard.classList.remove('hidden');
            document.getElementById('preview-container').classList.add('processing');

            const zip = new JSZip();
            const pdfData = await currentFile.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: pdfData, verbosity: 0}).promise;
            const total = pdf.numPages;
            const isTransparent = document.getElementById('transparent-toggle').checked;

            let processed = 0;
            const concurrency = Math.min(navigator.hardwareConcurrency || 4, 8);
            const queue = Array.from({length: total}, (_, i) => i + 1);

            const startTime = Date.now();

            const worker = async () => {
                while (queue.length > 0 && isProcessing) {
                    const pageNum = queue.shift();
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 2.0 });
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', { alpha: true });
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    await page.render({ canvasContext: ctx, viewport, background: 'transparent' }).promise;

                    if (isTransparent) {
                        const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = new Uint32Array(img.data.buffer);
                        for (let i = 0; i < data.length; i++) {
                            if ((data[i] & 0x00FFFFFF) === 0x00FFFFFF) data[i] = 0;
                        }
                        ctx.putImageData(img, 0, 0);
                    }

                    const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
                    zip.file(`${pageNum}.png`, blob);

                    processed++;
                    updateUI(processed, total, startTime, canvas.toDataURL());
                    
                    // Cleanup to save memory
                    canvas.width = 0; canvas.height = 0;
                }
            };

            await Promise.all(Array(concurrency).fill(null).map(worker));

            if (!isProcessing) return;

            // Phase 2: Packing
            document.getElementById('process-label').textContent = "Finalizing ZIP Archive...";
            document.getElementById('process-label').classList.add('text-green-400');
            
            zipResultBlob = await zip.generateAsync({ type: "blob", compression: "STORE" });
            
            finishUI();
        }

        function updateUI(current, total, startTime, previewUrl) {
            const pc = Math.floor((current / total) * 100);
            progressBar.style.width = `${pc}%`;
            document.getElementById('percent-label').textContent = `${pc}%`;
            pageCountEl.textContent = `PAGE ${current} / ${total}`;
            
            if (current % 2 === 0) document.getElementById('main-preview').src = previewUrl;

            // Simple time estimate
            const elapsed = (Date.now() - startTime) / 1000;
            const remaining = Math.round((elapsed / current) * (total - current));
            if (remaining > 0) document.getElementById('time-estimate').textContent = `${remaining}s LEFT`;
        }

        function finishUI() {
            isProcessing = false;
            document.getElementById('preview-container').classList.remove('processing');
            convertBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
            downloadBtn.classList.remove('hidden');
            document.getElementById('success-overlay').classList.replace('hidden', 'flex');
        }

        downloadBtn.onclick = () => {
            if (!zipResultBlob) return;
            const url = URL.createObjectURL(zipResultBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AlphaSnap_${Date.now()}.zip`;
            a.click();
            setTimeout(() => URL.revokeObjectURL(url), 10000);
        };

        cancelBtn.onclick = () => location.reload();

        async function updateUsage() {
    const res = await fetch('/api/status', { headers: { 'x-device-id': deviceId } });
    const data = await res.json();
    
    const usageTag = document.getElementById('usage-tag');
    const modalLeft = document.getElementById('modal-usage-left');
    const modalStatusText = document.getElementById('modal-status-text');
    
    // 残り回数を計算 (最大3回)
    const remaining = Math.max(0, 3 - data.count);

    if (data.is_vip) {
        // VIPの場合
        usageTag.innerHTML = `<span class="text-blue-500 font-black">VIP MEMBER</span>`;
        if (modalStatusText) {
            modalStatusText.innerHTML = `<span class="text-blue-400">STATUS: UNLIMITED ACCESS</span>`;
        }
    } else {
        // 無料ユーザーの場合
        usageTag.textContent = `FREE(無料枠): ${remaining} / 3 LEFT`;
        
        // モーダル内のカウントダウン表示
        if (modalLeft) {
            modalLeft.textContent = remaining;
            // 残り0回なら文字を赤くして警告感を出す
            if (remaining === 0) {
                modalLeft.classList.replace('text-blue-500', 'text-red-500');
            } else {
                modalLeft.classList.add('text-blue-500');
            }
        }
    }
}

        function showVipModal() { document.getElementById('vip-modal').classList.replace('hidden', 'flex'); }
        function hideVipModal() { document.getElementById('vip-modal').classList.replace('flex', 'hidden'); }

        async function unlockVip() {
            const password = document.getElementById('vip-pass').value;
            const res = await fetch('/api/unlock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-device-id': deviceId },
                body: JSON.stringify({ password })
            });
            if (res.ok) location.reload();
            else alert('Invalid Passcode');
        }

        // 利用規約の表示制御
        const termsModal = document.getElementById('terms-modal');
        document.getElementById('openTerms').onclick = () => termsModal.classList.replace('hidden', 'flex');
        document.getElementById('closeTermsBtn').onclick = () => termsModal.classList.replace('flex', 'hidden');
        
        // モーダル外クリックで閉じる
        termsModal.onclick = (e) => { if(e.target === termsModal) termsModal.classList.replace('flex', 'hidden'); };
        
        updateUsage();
    </script>
</body>
</html>
















