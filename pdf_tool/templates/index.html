<!DOCTYPE html>
<html lang="ja">
<head>
      <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MTB190WE2E"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MTB190WE2E');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFã‚’300dpié«˜ç”»è³ªPNGã¸å¤‰æ›ï½œèƒŒæ™¯é€éãƒ»ãƒ–ãƒ©ã‚¦ã‚¶å®Œçµã§å®‰å…¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    
    <style>
        :root { --primary: #3b82f6; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --error: #ef4444; --success: #22c55e; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 40px 20px; margin: 0; }
        
        .container { background: var(--card); width: 100%; max-width: 520px; padding: 32px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        h1 { text-align: center; margin-bottom: 24px; color: var(--primary); }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ */
        .status-card { background: rgba(15, 23, 42, 0.6); padding: 20px; border-radius: 16px; text-align: center; border: 1px solid #334155; margin-bottom: 24px; }
        .count-display { font-size: 2.5rem; font-weight: 800; margin: 10px 0; letter-spacing: 1px; }
        .badge { display: inline-block; padding: 6px 12px; border-radius: 99px; font-size: 0.85rem; font-weight: bold; }
        .badge-success { color: var(--success); background: rgba(34, 197, 94, 0.1); border: 1px solid var(--success); }
        .badge-error { color: var(--error); background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); }
        .badge-vip { color: #facc15; background: rgba(250, 204, 21, 0.1); border: 1px solid #facc15; box-shadow: 0 0 10px rgba(250, 204, 21, 0.2); }

        /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ */
        .drop-zone { 
            border: 2px dashed #475569; border-radius: 16px; padding: 40px 20px; text-align: center; 
            cursor: pointer; transition: 0.3s; margin-bottom: 20px; background: rgba(255,255,255,0.02);
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        .drop-zone p { margin: 0; color: #94a3b8; pointer-events: none; }
        .drop-zone strong { display: block; font-size: 1.1rem; color: var(--text); margin-bottom: 5px; pointer-events: none; }
        
        /* ãƒ•ã‚¡ã‚¤ãƒ«åè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #file-name-display {
            display: none; background: #0f172a; padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary);
            margin-bottom: 20px; font-weight: bold; color: var(--primary); text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        /* åˆ¶é™è§£é™¤ã‚¨ãƒªã‚¢ */
        .unlock-area { background: rgba(255,255,255,0.03); padding: 16px; border-radius: 12px; margin-bottom: 24px; border: 1px solid #334155; }
        .unlock-row { display: flex; gap: 10px; margin-top: 10px; }
        
        input[type="password"] { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #475569; background: #0f172a; color: white; }
        .btn-unlock { padding: 0 20px; background: #475569; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-unlock:hover { background: #64748b; }
        
        /* å¤‰æ›ãƒœã‚¿ãƒ³ */
        .btn-main { width: 100%; padding: 16px; background: var(--primary); color: #0f172a; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-main:hover { filter: brightness(1.1); }
        .btn-main:disabled { background: #334155; color: #64748b; cursor: not-allowed; }

        .log-area { margin-top: 20px; font-size: 0.8rem; color: #94a3b8; height: 100px; overflow-y: auto; background: #0b1120; padding: 10px; border-radius: 8px; display: none; }
        .vip-msg { display: none; color: #facc15; font-weight: bold; text-align: center; margin-bottom: 10px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
       <h1 style="font-size: 1.3rem; text-align: center;">
          PDFå¤‰æ› [300dpiãƒ»é€éãƒ»å®‰å…¨]
      </h1>

        <div class="status-card">
            <div style="font-size:0.9rem; color:#94a3b8;">æœ¬æ—¥ã®åˆ©ç”¨çŠ¶æ³</div>
            <div id="count-display" class="count-display">--- / 3</div>
            <span id="status-badge" class="badge">ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ä¸­...</span>
        </div>

        <div id="unlock-section" class="unlock-area">
            <div id="vip-message" class="vip-msg">âœ¨ åˆ¶é™ãŒè§£é™¤ã•ã‚Œã¾ã—ãŸã€‚ç„¡åˆ¶é™ã«ä½¿ãˆã¾ã™ âœ¨</div>
            <div id="unlock-form">
                <label style="font-size:0.85rem; color:#ef4444;">â€»ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼ˆå±¥æ­´ã®å‰Šé™¤ï¼‰ã§ä½•å›ã§ã‚‚ä¸Šé™ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€€ã€€â€»â†“ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§åˆ¶é™ã‚’è§£é™¤ã™ã‚‹â†“</label>
                <div class="unlock-row">
                    <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                    <button class="btn-unlock" onclick="unlockLimit()">è§£é™¤</button>
                </div>
            </div>
        </div>

        <div id="drop-zone" class="drop-zone">
            <strong>ã“ã“ã«PDFã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</strong>
            <p>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
            <input type="file" id="fileInput" accept=".pdf" style="display:none;">
        </div>

        <div id="file-name-display"></div>

        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <label style="cursor:pointer;"><input type="checkbox" id="transparentCheck" checked> ç™½èƒŒæ™¯ã‚’é€æ˜ã«ã™ã‚‹</label>
            <select id="dpiSelect" style="padding: 5px; border-radius: 5px; background: #0f172a; color: white; border: 1px solid #475569;">
                <option value="150">150 DPI</option>
                <option value="300" selected>300 DPI</option>
            </select>
        </div>

        <button id="runBtn" class="btn-main" onclick="startConversion()">å¤‰æ›ã‚’å®Ÿè¡Œ</button>
        <div id="logArea" class="log-area"></div>
    </div>

    <canvas id="hiddenCanvas" style="display:none;"></canvas>

    <script>
        const DAILY_LIMIT = 3;
        
        // --- ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å¿…ãšã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— ---
        window.onload = async () => {
            await syncWithServer();
        };

        async function syncWithServer() {
            try {
                const res = await fetch('/api/status');
                if (res.ok) {
                    const data = await res.json();
                    updateUI(data.count, data.is_vip);
                }
            } catch (e) { console.error("Server sync failed", e); }
        }

        // --- ç”»é¢è¡¨ç¤ºã®æ›´æ–° ---
        function updateUI(count, isVip) {
            const countDisplay = document.getElementById('count-display');
            const statusBadge = document.getElementById('status-badge');
            const unlockForm = document.getElementById('unlock-form');
            const vipMsg = document.getElementById('vip-message');

            if (isVip) {
                countDisplay.textContent = "âˆ (ç„¡åˆ¶é™)";
                statusBadge.textContent = "åˆ¶é™è§£é™¤æ¸ˆã¿ï¼šç„¡åˆ¶é™ã«ä½¿ãˆã¾ã™";
                statusBadge.className = "badge badge-vip";
                unlockForm.style.display = 'none';
                vipMsg.style.display = 'block';
            } else {
                countDisplay.textContent = `${count} / ${DAILY_LIMIT}`;
                
                if (count >= DAILY_LIMIT) {
                    statusBadge.innerHTML = 'æœ¬æ—¥ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚<br><small>åˆ¶é™ã‚’ç„¡åˆ¶é™ã«ã™ã‚‹ã«ã¯<a href="ã‚ãªãŸã®æ±ºæ¸ˆãƒšãƒ¼ã‚¸URL" target="_blank" style="color: white; text-decoration: underline; margin-left: 8px;">ã“ã¡ã‚‰</a>ã‹ã‚‰ãŠæ”¯æ‰•ã„ãã ã•ã„</small>';
                    statusBadge.className = "badge badge-error";
                } else {
                    statusBadge.textContent = `ã‚ã¨ ${DAILY_LIMIT - count} å› åˆ©ç”¨å¯èƒ½ã§ã™`;
                    statusBadge.className = "badge badge-success";
                }
                
                unlockForm.style.display = 'block';
                vipMsg.style.display = 'none';
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç† ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('file-name-display');
        const logArea = document.getElementById('logArea');
        const runBtn = document.getElementById('runBtn');

        function log(msg) { 
            logArea.style.display = 'block'; 
            logArea.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`; 
            logArea.scrollTop = logArea.scrollHeight;
        }

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
        dropZone.ondragleave = () => dropZone.classList.remove('dragover');
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        };
        fileInput.onchange = () => handleFiles(fileInput.files);

        function handleFiles(files) {
            if (files.length === 0) return;
            const file = files[0];
            if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) {
                alert("PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿é¸æŠå¯èƒ½ã§ã™ã€‚");
                return;
            }
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;

            fileNameDisplay.textContent = "ğŸ“„ é¸æŠä¸­: " + file.name;
            fileNameDisplay.style.display = 'block';
        }

        // --- åˆ¶é™è§£é™¤å‡¦ç† ---
        async function unlockLimit() {
            const pwd = document.getElementById('passwordInput').value;
            if (!pwd) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            try {
                const res = await fetch('/api/unlock', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({password: pwd})
                });
                const data = await res.json();

                if (res.ok) {
                    alert("åˆ¶é™ãŒè§£é™¤ã•ã‚Œã¾ã—ãŸï¼");
                    await syncWithServer(); // æˆåŠŸã—ãŸã‚‰å³åŒæœŸ
                } else {
                    alert(data.message);
                }
            } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); }
        }

        // --- å¤‰æ›å®Ÿè¡Œå‡¦ç† ---
        async function startConversion() {
            if (fileInput.files.length === 0) return alert("PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");

            runBtn.disabled = true;
            runBtn.textContent = "ã‚µãƒ¼ãƒãƒ¼èªè¨¼ä¸­...";
            logArea.innerHTML = '';

            try {
                // 1. ã‚µãƒ¼ãƒãƒ¼ã¸ã‚«ã‚¦ãƒ³ãƒˆåŠ ç®—ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆã“ã‚ŒãŒæœ€é‡è¦ï¼‰
                const res = await fetch('/api/increment', { method: 'POST' });
                const data = await res.json();

                if (!res.ok) {
                    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ‹’å¦ã•ã‚ŒãŸã‚‰å³åœæ­¢
                    updateUI(data.count, data.is_vip);
                    alert(data.message || "ä¸Šé™ã‚¨ãƒ©ãƒ¼");
                    runBtn.disabled = false;
                    runBtn.textContent = "å¤‰æ›ã‚’å®Ÿè¡Œ";
                    return;
                }

                // 2. è¨±å¯ã•ã‚ŒãŸå ´åˆã€æœ€æ–°ã®ã‚«ã‚¦ãƒ³ãƒˆã§UIæ›´æ–°
                updateUI(data.count, data.is_vip);
                log("èªè¨¼OKã€‚å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...");

                // 3. å¤‰æ›å‡¦ç†å®Ÿè¡Œ
                await processPdf(fileInput.files[0]);

            } catch(e) {
                console.error(e);
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
                runBtn.disabled = false;
                runBtn.textContent = "å¤‰æ›ã‚’å®Ÿè¡Œ";
            }
        }

        async function processPdf(file) {
            const dpi = parseInt(document.getElementById('dpiSelect').value);
            const doTransparent = document.getElementById('transparentCheck').checked;
            
            log("PDFã‚’èª­ã¿è¾¼ã¿ä¸­...");
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const zip = new JSZip();
            const canvas = document.getElementById('hiddenCanvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            
            for (let i = 1; i <= pdf.numPages; i++) {
                log(`ãƒšãƒ¼ã‚¸å‡¦ç†ä¸­... (${i}/${pdf.numPages})`);
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: dpi / 72 });
                canvas.width = viewport.width; canvas.height = viewport.height;
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                if (doTransparent) {
                    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const d = imgData.data;
                    // é€éå‡¦ç†ï¼ˆé–¾å€¤250ã§é«˜ç²¾åº¦åŒ–ï¼‰
                    for (let j = 0; j < d.length; j += 4) {
                        if (d[j] > 250 && d[j+1] > 250 && d[j+2] > 250) d[j+3] = 0;
                    }
                    ctx.putImageData(imgData, 0, 0);
                }

                const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
                zip.file(`page_${String(i).padStart(3, '0')}.png`, blob);
            }

            log("ZIPåœ§ç¸®ä¸­...");
            const content = await zip.generateAsync({ type: "blob" });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = file.name.replace('.pdf', '') + "_converted.zip";
            link.click();
            
            log("å®Œäº†ã—ã¾ã—ãŸï¼");
            runBtn.disabled = false;
            runBtn.textContent = "å¤‰æ›ã‚’å®Ÿè¡Œ";
        }
    </script>
</body>
</html>







