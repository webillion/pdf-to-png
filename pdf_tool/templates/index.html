<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>AlphaSnap | v3.3 Fixed Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #020617; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .checkerboard { background-image: linear-gradient(45deg, #e5e7eb 25%, transparent 25%), linear-gradient(-45deg, #e5e7eb 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #e5e7eb 75%), linear-gradient(-45deg, transparent 75%, #e5e7eb 75%); background-size: 10px 10px; background-color: #f3f4f6; }
        .processing * { pointer-events: none !important; }
        .allow-cancel { pointer-events: auto !important; cursor: pointer !important; }
        #scroll-area { scroll-behavior: smooth; }
        /* スクロールバーのカスタマイズ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-300">

    <header class="h-[280px] bg-slate-900 border-b border-white/10 shadow-2xl z-50 p-6 flex gap-8">
        <div class="w-[300px] flex flex-col justify-between">
            <div>
                <h1 class="text-2xl font-black italic text-white flex items-center gap-2 mb-1">
                    <i data-lucide="zap" class="text-blue-500 fill-blue-500"></i> AlphaSnap
                </h1>
                <div id="usage-text" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest italic">Checking...</div>
            </div>

            <div class="space-y-3">
                <button id="drop-zone" class="w-full py-3 border-2 border-dashed border-slate-700 rounded-xl text-[10px] font-black text-slate-500 uppercase hover:border-blue-500 transition-all">
                    ファイルをドロップ
                    <input type="file" id="file-input" class="hidden" accept="application/pdf">
                </button>
                <div class="flex gap-2">
                    <button id="convert-btn" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-black py-3 rounded-xl text-xs transition-all shadow-lg">変換開始</button>
                    <button id="cancel-btn" class="allow-cancel hidden bg-red-600 hover:bg-red-500 text-white font-black px-4 rounded-xl text-xs transition-all">中止</button>
                </div>
            </div>
        </div>

        <div id="live-panel" class="flex-1 bg-slate-950/50 rounded-2xl border border-white/5 p-4 flex items-center gap-6 opacity-30">
            <div class="h-full aspect-[1/1.4] checkerboard rounded overflow-hidden border border-white/10">
                <img id="spotlight-img" class="w-full h-full object-contain">
            </div>
            <div class="flex-1">
                <p id="progress-label" class="text-[10px] font-black text-blue-500 uppercase mb-1">Status: Ready</p>
                <h2 id="current-page-num" class="text-4xl font-black text-white italic tracking-tighter mb-4">PAGE #---</h2>
                <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-blue-500 w-0 transition-all duration-300"></div>
                </div>
                <div class="flex justify-between mt-2 text-[10px] font-bold text-slate-500">
                    <span id="progress-count">0 / 0</span>
                    <span id="percentage-text">0%</span>
                </div>
            </div>
        </div>

        <div class="w-[180px] flex flex-col justify-center gap-4">
            <div class="bg-slate-800/50 p-3 rounded-xl border border-white/5">
                <p class="text-[9px] font-black text-slate-500 mb-2 uppercase">Background</p>
                <div class="flex items-center justify-between">
                    <span class="text-[10px] font-bold">透明化</span>
                    <input type="checkbox" id="transparent-toggle" checked class="w-4 h-4 rounded border-slate-700 bg-slate-800 text-blue-600">
                </div>
            </div>
        </div>
    </header>

    <main id="scroll-area" class="flex-1 overflow-y-auto p-8 relative">
        <div id="result-area">
            </div>
        
        <div id="overlay-screen" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
            <div id="empty-msg" class="text-slate-800 font-black text-4xl italic uppercase tracking-[0.2em]">Ready for action</div>
            <div id="complete-msg" class="hidden text-center pointer-events-auto">
                <div class="bg-green-500/10 text-green-500 p-6 rounded-full mb-4 inline-block"><i data-lucide="check" class="w-12 h-12"></i></div>
                <h2 class="text-2xl font-black text-white mb-6 italic uppercase tracking-tighter">Mission Accomplished</h2>
                <button onclick="location.reload()" class="bg-slate-800 hover:bg-slate-700 text-white font-black px-8 py-3 rounded-xl text-sm transition-all">新しいファイルを処理</button>
            </div>
        </div>
    </main>

    <div id="vip-modal" class="fixed inset-0 bg-slate-950/95 hidden items-center justify-center z-[100] backdrop-blur-md">
        <div class="bg-white p-10 rounded-3xl max-w-sm w-full text-center text-slate-900 shadow-2xl">
            <h3 class="text-xl font-black mb-4 uppercase">Limit Reached</h3>
            <p class="text-xs text-slate-500 font-bold mb-6 uppercase">パスコードを入力してください</p>
            <input type="password" id="vip-password" placeholder="PASSCODE" class="w-full p-4 bg-slate-100 rounded-xl mb-4 text-center font-bold border-none outline-none focus:ring-2 ring-blue-500">
            <button onclick="unlockVip()" class="w-full py-4 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition-all shadow-xl">AUTHENTICATE</button>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const convertBtn = document.getElementById('convert-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressCount = document.getElementById('progress-count');
        const percentageText = document.getElementById('percentage-text');
        const resultArea = document.getElementById('result-area');
        const transparentToggle = document.getElementById('transparent-toggle');
        const livePanel = document.getElementById('live-panel');
        const spotlightImg = document.getElementById('spotlight-img');
        const currentPageNum = document.getElementById('current-page-num');
        const progressLabel = document.getElementById('progress-label');

        let currentFile = null;
        let isCancelling = false;
        let currentProcessId = 0;

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => { currentFile = e.target.files[0]; document.getElementById('empty-msg').textContent = currentFile.name; };

        convertBtn.onclick = async () => {
            if (!currentFile) return;
            const res = await fetch('/api/status');
            const data = await res.json();
            if (data.count >= 3 && !data.is_vip) { document.getElementById('vip-modal').classList.replace('hidden', 'flex'); return; }

            const incRes = await fetch('/api/increment', { method: 'POST' });
            if (incRes.status === 403) { document.getElementById('vip-modal').classList.replace('hidden', 'flex'); return; }

            isCancelling = false;
            document.body.classList.add('processing');
            convertBtn.classList.add('hidden');
            cancelBtn.classList.remove('hidden');
            livePanel.classList.remove('opacity-30');
            document.getElementById('empty-msg').classList.add('hidden');
            document.getElementById('complete-msg').classList.add('hidden');
            
            await processTurbo(currentFile);
            checkStatus();
        };

        cancelBtn.onclick = () => { isCancelling = true; currentProcessId++; location.reload(); };

        async function processTurbo(file) {
            const thisProcessId = ++currentProcessId;
            resultArea.innerHTML = '';
            const zip = new JSZip();
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer, verbosity: 0}).promise;
            const total = pdf.numPages;
            
            const sampleStep = Math.max(1, Math.floor(total / 50));
            const previewIndices = Array.from({length: total}, (_, i) => i + 1).filter(i => i===1 || i%sampleStep===0 || i===total);

            const concurrency = Math.min(navigator.hardwareConcurrency || 4, 8);
            let processed = 0;
            const queue = Array.from({length: total}, (_, i) => i + 1);

            const workers = Array(concurrency).fill(null).map(async () => {
                while (queue.length > 0) {
                    if (isCancelling || thisProcessId !== currentProcessId) return;
                    const pageNum = queue.shift();
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 2.0 });
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width; canvas.height = viewport.height;
                    const ctx = canvas.getContext('2d', { alpha: true });
                    await page.render({ canvasContext: ctx, viewport, background: 'transparent' }).promise;
                    
                    if (transparentToggle.checked) {
                        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = new Uint32Array(imgData.data.buffer);
                        for (let i = 0; i < data.length; i++) {
                            const v = data[i];
                            if ((v & 0xFF) >= 250 && ((v >> 8) & 0xFF) >= 250 && ((v >> 16) & 0xFF) >= 250) data[i] = 0;
                        }
                        ctx.putImageData(imgData, 0, 0);
                    }

                    const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
                    zip.file(`${pageNum}.png`, blob);
                    const url = URL.createObjectURL(blob);

                    spotlightImg.src = url;
                    currentPageNum.textContent = `PAGE #${pageNum}`;

                    if (previewIndices.includes(pageNum)) {
                        const div = document.createElement('div');
                        div.className = `img-reveal rounded-lg overflow-hidden border border-white/5 shadow-2xl ${transparentToggle.checked ? 'checkerboard' : 'bg-white'}`;
                        div.innerHTML = `<img src="${url}" class="w-full h-full object-contain">`;
                        resultArea.appendChild(div);
                    }

                    processed++;
                    const percent = Math.floor((processed / total) * 100);
                    progressBar.style.width = percent + '%';
                    percentageText.textContent = percent + '%';
                    progressCount.textContent = `${processed} / ${total}`;
                }
            });

            await Promise.all(workers);
            if (isCancelling || thisProcessId !== currentProcessId) return;

            cancelBtn.classList.add('hidden');
            progressLabel.textContent = "Status: Packing ZIP...";
            progressLabel.classList.add('animate-pulse', 'text-green-400');
            progressBar.classList.replace('bg-blue-500', 'bg-green-500');

            const content = await zip.generateAsync({ type: "blob", compression: "STORE" }, (m) => {
                percentageText.textContent = Math.floor(m.percent) + '%';
                progressBar.style.width = m.percent + '%';
            });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `AlphaSnap_${Date.now()}.zip`;
            link.click();

            document.getElementById('complete-msg').classList.remove('hidden');
            document.body.classList.remove('processing');
        }

        async function checkStatus() {
            const res = await fetch('/api/status');
            const data = await res.json();
            const txt = document.getElementById('usage-text');
            txt.innerHTML = data.is_vip ? '<span class="text-blue-400">✨ VIP UNLIMITED</span>' : `TODAY: ${Math.max(0, 3 - data.count)} / 3 REMAINING`;
        }
        async function unlockVip() {
            const res = await fetch('/api/unlock', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ password: document.getElementById('vip-password').value })});
            if ((await res.json()).status === 'success') location.reload(); else alert('Invalid Passcode');
        }
        checkStatus();
    </script>
</body>
</html>
