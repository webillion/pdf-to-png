<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to PNG Converter Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script> [cite: 1]
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script> [cite: 1]
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script> [cite: 1]
    <style>
        body { font-family: sans-serif; background-color: #0f172a; color: #f8fafc; display: flex; justify-content: center; padding-top: 50px; } [cite: 2, 3]
        .container { background: #1e293b; width: 100%; max-width: 500px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); } [cite: 4, 5]
        .status-card { background: rgba(15,23,42,0.5); padding: 20px; text-align: center; border-radius: 12px; margin-bottom: 25px; border: 1px solid #334155; } [cite: 6, 7]
        .counter-wrapper { font-size: 2.5rem; font-weight: bold; color: #38bdf8; margin: 10px 0; } [cite: 7, 8]
        .badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; } [cite: 9]
        .badge-success { background: rgba(34,197,94,0.1); color: #22c55e; border: 1px solid #22c55e; } [cite: 10, 11]
        .badge-error { background: rgba(239,68,68,0.1); color: #f43f5e; border: 1px solid #f43f5e; } [cite: 11, 12]
        
        .drop-zone { border: 2px dashed #475569; border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: 0.3s; margin-bottom: 20px; } [cite: 13]
        .drop-zone:hover { border-color: #38bdf8; background: rgba(56,189,248,0.05); }
        #file-list { font-size: 0.85rem; color: #38bdf8; margin-top: 10px; }

        .input-field { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; margin-bottom: 15px; box-sizing: border-box; } [cite: 14, 15]
        button { width: 100%; padding: 16px; background: #38bdf8; color: #0f172a; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; } [cite: 16]
        button:disabled { background: #475569; color: #94a3b8; cursor: not-allowed; } [cite: 17, 18]
        
        #pass-area { display: none; background: rgba(239,68,68,0.05); padding: 15px; border-radius: 8px; border: 1px dashed #f43f5e; margin-bottom: 20px; } [cite: 18, 19]
        #log-area { margin-top: 20px; font-size: 0.8rem; background: #0f172a; padding: 10px; border-radius: 6px; height: 80px; overflow-y: auto; display: none; } [cite: 21, 22]
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF Converter</h1> [cite: 23]
        <div class="status-card">
            <div id="count-display" class="counter-wrapper">--- / ---</div> [cite: 23]
            <span id="status-badge" class="badge badge-success">状況確認中...</span> [cite: 24]
        </div>

        <div class="drop-zone" id="drop-zone">
            <strong>ここにPDFをドロップ</strong>
            <p id="file-list">またはクリックして選択</p>
            <input type="file" id="pdfFile" accept=".pdf" style="display:none"> [cite: 25]
        </div>

        <div id="pass-area">
            <label style="color:#f43f5e; font-size:0.8rem;">制限解除パスワード</label> [cite: 26]
            <input type="password" id="passwordInput" class="input-field" placeholder="パスワード入力"> [cite: 26]
        </div>

        <div class="form-group">
            <label style="font-size:0.85rem;"><input type="checkbox" id="transparentCheck"> 白背景を透明にする</label> [cite: 26]
        </div>

        <button id="runBtn" onclick="startProcess()">変換を実行</button> [cite: 26]
        <div id="log-area"></div> [cite: 27]
    </div>

    <canvas id="hiddenCanvas" style="display:none"></canvas> [cite: 27]

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('pdfFile');
        const logArea = document.getElementById('log-area');

        function log(msg) { logArea.style.display = 'block'; logArea.textContent = msg; } [cite: 28]

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = () => { document.getElementById('file-list').textContent = fileInput.files[0].name; };
        
        function updateUI(data) {
            document.getElementById('count-display').textContent = data.text_count; [cite: 29]
            const badge = document.getElementById('status-badge');
            badge.textContent = data.text_message; [cite: 30]
            badge.className = 'badge ' + data.css_badge; [cite: 30]
            document.getElementById('pass-area').style.display = data.show_pass ? 'block' : 'none'; [cite: 31, 32]
        }

        window.onload = async () => {
            const res = await fetch('/api/status'); [cite: 33]
            const data = await res.json(); [cite: 34]
            updateUI(data); [cite: 34]
        };

        async function startProcess() {
            const runBtn = document.getElementById('runBtn');
            if (fileInput.files.length === 0) return alert("ファイルを選んでください"); [cite: 37, 38]

            runBtn.disabled = true;
            runBtn.textContent = "認証中..."; [cite: 38]

            try {
                const res = await fetch('/api/check_auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: document.getElementById('passwordInput').value }) [cite: 39, 40]
                });
                const data = await res.json(); [cite: 41]

                if (!res.ok) {
                    alert(data.message); [cite: 41]
                    runBtn.disabled = false;
                    runBtn.textContent = "変換を実行"; [cite: 42]
                    return;
                }

                updateUI(data.ui_data); [cite: 44]
                if (document.getElementById('passwordInput').value) {
                    log("制限を解除しました。無制限で使えます。");
                }
                
                await convertPdfToPng(fileInput.files[0]); [cite: 45]
            } catch (e) { alert(e.message); runBtn.disabled = false; } [cite: 46, 47]
        }

        async function convertPdfToPng(file) {
            const doTransparent = document.getElementById('transparentCheck').checked; [cite: 49]
            const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise; [cite: 49]
            const zip = new JSZip(); [cite: 49]
            const canvas = document.getElementById('hiddenCanvas'); [cite: 50]
            const ctx = canvas.getContext('2d', { willReadFrequently: true }); [cite: 50]

            for (let i = 1; i <= pdf.numPages; i++) { [cite: 51]
                log(`処理中... ${i} / ${pdf.numPages}`); [cite: 51]
                const page = await pdf.getPage(i); [cite: 52]
                const viewport = page.getViewport({ scale: 300 / 72 }); [cite: 52]
                canvas.width = viewport.width; canvas.height = viewport.height; [cite: 53]
                await page.render({ canvasContext: ctx, viewport: viewport }).promise; [cite: 53]

                if (doTransparent) { [cite: 54]
                    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height); [cite: 54]
                    for (let j = 0; j < imgData.data.length; j += 4) {
                        if (imgData.data[j]>245 && imgData.data[j+1]>245 && imgData.data[j+2]>245) imgData.data[j+3] = 0; [cite: 55]
                    }
                    ctx.putImageData(imgData, 0, 0); [cite: 56]
                }
                zip.file(`page_${i}.png`, await new Promise(r => canvas.toBlob(r, 'image/png'))); [cite: 57, 58]
            }
            const content = await zip.generateAsync({ type: "blob" }); [cite: 59]
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = "images.zip";
            link.click(); [cite: 59]
            log("完了しました！"); [cite: 59]
            runBtn.disabled = false; [cite: 60]
            runBtn.textContent = "変換を実行"; [cite: 60]
        }
    </script>
</body>
</html>
