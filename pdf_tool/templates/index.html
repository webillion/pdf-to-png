<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to PNG Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f4f7f6; color: #333; display: flex; justify-content: center; padding-top: 50px; }
        .container { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #444; margin-bottom: 25px; font-size: 1.5rem; }

        .status-card { background-color: #f8f9fa; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 25px; border: 1px solid #eee; }
        .counter-wrapper { font-size: 2.5rem; font-weight: bold; color: #333; line-height: 1; margin: 10px 0; }
        
        .badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .badge-loading { background-color: #eee; color: #777; border: 1px solid #ddd; } /* 読み込み中用 */
        .badge-success { background-color: #e6f9ed; color: #28a745; border: 1px solid #c3e6cb; }
        .badge-error { background-color: #fbeaea; color: #dc3545; border: 1px solid #f5c6cb; }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.9rem; }
        input[type="file"], input[type="password"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; background-color: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .password-section { display: none; background-color: #fff5f5; padding: 15px; border-radius: 6px; border: 1px dashed #ffcccc; margin-top: 15px; }
        .password-section.show { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #log-area { margin-top: 20px; font-size: 0.8rem; color: #666; height: 80px; overflow-y: auto; background: #fafafa; border: 1px solid #eee; padding: 10px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF to PNG Converter</h1>

        <div class="status-card">
            <div>本日の利用状況</div>
            
            <div id="count-display" class="counter-wrapper">
                --- / ---
            </div>
            
            <div>
                <span id="status-badge" class="badge badge-loading">
                    状況を確認中...
                </span>
            </div>
        </div>

        <div class="form-group">
            <label>PDFファイルを選択</label>
            <input type="file" id="pdfFile" accept=".pdf">
        </div>

        <div class="form-group">
            <label>解像度</label>
            <label style="display:inline; margin-right:15px;"><input type="radio" name="dpi" value="150"> 150 DPI</label>
            <label style="display:inline;"><input type="radio" name="dpi" value="300" checked> 300 DPI</label>
        </div>

        <div class="form-group">
            <label style="font-weight:normal;"><input type="checkbox" id="transparentCheck"> 白背景を透明にする</label>
        </div>

        <div id="pass-area" class="password-section">
            <label style="color:#dc3545;">制限解除パスワード</label>
            <input type="password" id="passwordInput" placeholder="パスワードを入力してください">
        </div>

        <button id="runBtn" onclick="startProcess()">変換を実行</button>
        <div id="log-area"></div>
    </div>

    <canvas id="hiddenCanvas" style="display: none;"></canvas>

    <script>
        const logArea = document.getElementById('log-area');
        function log(msg) {
            logArea.style.display = 'block';
            logArea.textContent = msg;
        }

        // 画面の文字を更新する関数
        function updateUI(uiData) {
            document.getElementById('count-display').textContent = uiData.text_count;
            
            const badge = document.getElementById('status-badge');
            badge.textContent = uiData.text_message;
            badge.className = 'badge ' + uiData.css_badge;

            const passArea = document.getElementById('pass-area');
            if (uiData.show_pass) {
                passArea.classList.add('show');
            } else {
                passArea.classList.remove('show');
            }
        }

        // ★ページが開かれたらすぐにPythonから初期状態を取得する
        window.onload = async function() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                updateUI(data); // 画面を「---」から「0 / 3」などに書き換え
            } catch(e) {
                console.error("初期データ取得エラー", e);
                document.getElementById('status-badge').textContent = "通信エラー";
            }
        };

        async function startProcess() {
            const fileInput = document.getElementById('pdfFile');
            const passwordInput = document.getElementById('passwordInput');
            const runBtn = document.getElementById('runBtn');

            if (fileInput.files.length === 0) {
                alert("ファイルを選択してください。");
                return;
            }

            runBtn.disabled = true;
            runBtn.textContent = "認証中...";
            
            try {
                // 認証APIを叩く
                const res = await fetch('/api/check_auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: passwordInput.value })
                });
                const data = await res.json();

                if (!res.ok || data.status !== 'ok') {
                    alert(data.message || "認証エラー");
                    runBtn.disabled = false;
                    runBtn.textContent = "変換を実行";
                    
                    // エラー時の強制表示
                    document.getElementById('pass-area').classList.add('show');
                    const badge = document.getElementById('status-badge');
                    badge.textContent = "パスワードエラー";
                    badge.className = "badge badge-error";
                    return;
                }

                // 更新されたカウントとメッセージを反映
                updateUI(data.ui_data);
                
                log("認証成功。変換処理を開始します...");

                // PDF変換処理
                runBtn.textContent = "変換中...";
                await convertPdfToPng(fileInput.files[0]);

            } catch (e) {
                console.error(e);
                alert("エラー: " + e.message);
                runBtn.disabled = false;
                runBtn.textContent = "変換を実行";
            }
        }

        async function convertPdfToPng(file) {
            const dpi = document.querySelector('input[name="dpi"]:checked').value;
            const doTransparent = document.getElementById('transparentCheck').checked;
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const zip = new JSZip();
            const canvas = document.getElementById('hiddenCanvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const total = pdf.numPages;
            
            for (let i = 1; i <= total; i++) {
                log(`ページ処理中... ${i} / ${total}`);
                const page = await pdf.getPage(i);
                const scale = dpi / 72; 
                const viewport = page.getViewport({ scale: scale });
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                if (doTransparent) {
                    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const d = imgData.data;
                    for (let j = 0; j < d.length; j += 4) {
                        if (d[j]>245 && d[j+1]>245 && d[j+2]>245) d[j+3] = 0;
                    }
                    ctx.putImageData(imgData, 0, 0);
                }
                const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
                zip.file(`page_${String(i).padStart(3, '0')}.png`, blob);
            }
            
            log("ZIP圧縮中...");
            const content = await zip.generateAsync({ type: "blob" });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = "converted_images.zip";
            link.click();
            log("完了しました！");
            runBtn.disabled = false;
            runBtn.textContent = "変換を実行";
        }
    </script>
</body>
</html>
